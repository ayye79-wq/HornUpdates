<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horn Updates • Reader</title>

  <!-- ✅ AdSense loader -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7773342225754932"
    crossorigin="anonymous"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f5f6f8;
      color: #111827;
      line-height: 1.6;
    }
    .wrap { max-width: 920px; margin: 0 auto; padding: 18px; }
    .topbar { display:flex; justify-content:space-between; margin-bottom:14px; gap:10px; }
    .brand a { text-decoration:none; color:#111827; font-weight:900; }
    .btn {
      padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb;
      background:#fff; font-weight:700; cursor:pointer; text-decoration:none; color:#111827;
    }
    .btn.secondary { background:#f3f4f6; font-weight:600; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .card {
      background:#fff; border:1px solid #e5e7eb; border-radius:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.06); padding:18px;
    }
    .meta { color:#6b7280; font-size:.95rem; display:flex; gap:10px; flex-wrap:wrap; }
    .pill { background:#f3f4f6; padding:4px 10px; border-radius:999px; font-size:.85rem; }
    h1 { font-size:1.4rem; margin:10px 0; }
    .summary { font-size:1.02rem; white-space:pre-wrap; }
    .divider { height:1px; background:#e5e7eb; margin:18px 0; }
    .muted { color:#6b7280; }

    .reader-box {
      margin:22px 0; padding:16px; background:#f9fafb;
      border:1px solid #e5e7eb; border-radius:14px; display:none;
    }
    .reader-box h3 { margin:0 0 8px; font-size:1rem; }

    .rtl { direction:rtl; text-align:right; line-height:1.9; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <a href="index.html">Horn Updates</a>
      <span class="muted">• Reader</span>
    </div>
    <div class="actions">
      <a id="openBtn" class="btn" target="_blank" rel="noopener noreferrer">Read full article ↗</a>
      <button id="copyBtn" class="btn secondary" type="button">Copy link</button>
      <button id="shareBtn" class="btn secondary" type="button">Share</button>
      <a id="waBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">WhatsApp</a>
      <a id="tgBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">Telegram</a>
      <a id="fbBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">Facebook</a>
    </div>
  </div>

  <div class="card">
    <div class="meta">
      <span class="pill" id="sourcePill">Source</span>
      <span class="pill" id="datePill">Date</span>
      <span class="pill" id="countryPill" style="display:none;"></span>
    </div>

    <h1 id="title">Loading…</h1>
    <div class="divider"></div>
    <div id="summary" class="summary"><span class="muted">Loading summary…</span></div>

    <div class="reader-box" id="whyBox">
      <h3>Why this matters</h3>
      <p id="whyText"></p>
    </div>

    <div class="reader-ad reader-ad-top" style="margin:22px 0;">
      <ins class="adsbygoogle" style="display:block"
        data-ad-client="ca-pub-7773342225754932"
        data-ad-slot="8296199432"
        data-ad-format="auto"></ins>
    </div>
    <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>

    <div class="divider"></div>
    <div class="muted"><strong>Attribution:</strong> This summary is written by Horn Updates.</div>
  </div>
</div>

<script>
/* ========= helpers ========= */
function normalizeStr(s){ return (s ?? "").toString().toLowerCase().replace(/\s+/g," ").trim(); }
function safeArr(x){ return Array.isArray(x) ? x : (x ? [x] : []); }
function includesAny(h,n){ const s = normalizeStr(h); return safeArr(n).some(k => s.includes(normalizeStr(k))); }
function stableHash(str){
  let h = 2166136261;
  for (const c of String(str || "")) { h ^= c.charCodeAt(0); h = Math.imul(h, 16777619); }
  return h >>> 0;
}

function pickWhyThisMatters(article, cfg){
  const text = normalizeStr(`${article.title} ${article.summary} ${article.source} ${article.category || ""} ${(article.country_tags||[]).join(" ")}`);
  let best = null, p = -1;

  for (const g of (cfg.groups || [])){
    const kw = g?.match?.any_keyword || [];
    if (includesAny(text, kw) && (g.priority ?? 0) > p) { best = g; p = g.priority ?? 0; }
  }

  const t = (best?.templates && best.templates.length) ? best.templates : [cfg.default];

  // ✅ stable key even if title missing
  const key = (article.title || "").trim() || (article.source || "").trim() || "fallback";
  return t[stableHash(key) % t.length];
}

/* ========= config ========= */
const WHY_CFG = {
  default: { text: "Developments like this can signal broader regional or policy shifts affecting the Horn of Africa." },
  groups: [{
    priority: 100,
    match: { any_keyword: ["aid","humanitarian","wfp","unicef","usaid","refugee","refugees","famine","drought"] },
    templates: [
      { text: "Aid decisions can reshape access to food, medicine, and essential services, especially in fragile regions." },
      { text: "Humanitarian funding changes often reflect donor priorities and accountability concerns." }
    ]
  }]
};

/* ========= load ========= */
async function load(){
  const articleUrl = new URL(location.href).searchParams.get("url");
  if (!articleUrl) { location.href = "index.html"; return; }
  openBtn.href = articleUrl;

  // Load articles
  const res = await fetch("articles.json", { cache: "no-store" });
  const data = await res.json();
  const articles = Array.isArray(data) ? data : (data.articles || []);

  // Normalize URLs (hostname + pathname, no www, no trailing slash)
  function norm(u){
    try {
      const x = new URL(u);
      return x.hostname.replace(/^www\./, "") + x.pathname.replace(/\/$/, "");
    } catch { return ""; }
  }
  function urlOf(a){
    return norm(a.source_url || a.link || a.url || a.original_url || "");
  }
  function dateOf(a){
    const t =
      Date.parse(a?.published_at || "") ||
      Date.parse(a?.updated_at || "") ||
      Date.parse(a?.generated_at || "");
    return Number.isFinite(t) ? t : 0;
  }

  const target = norm(articleUrl);

  // 1) exact matches
  const exactMatches = articles.filter(a => urlOf(a) === target);

  // pick newest exact (if any)
  let match = null;
  if (exactMatches.length) {
    match = exactMatches.reduce((best, cur) => (dateOf(cur) > dateOf(best) ? cur : best));
  } else {
    // 2) fallback matches (tolerant)
    const fuzzyMatches = articles.filter(a => {
      const u = urlOf(a);
      return u && (u.includes(target) || target.includes(u));
    });

    if (fuzzyMatches.length) {
      match = fuzzyMatches.reduce((best, cur) => (dateOf(cur) > dateOf(best) ? cur : best));
    }
  }

  if (!match){
    title.textContent = "Article";
    summary.textContent = "We could not match this article in articles.json yet. You can still read the full story.";
    return;
  }

  // Render
  title.textContent = match.title || "Article";
  summary.textContent = match.summary || "";
  sourcePill.textContent = "Source: " + (match.source_name || "Source");
  datePill.textContent = "Date: " + (match.published_at ? new Date(match.published_at).toLocaleDateString() : "—");

  if (Array.isArray(match.country_tags) && match.country_tags.length) {
    countryPill.style.display = "inline-block";
    countryPill.textContent = "Country: " + match.country_tags.join(", ");
  }

  // Why this matters
  const why = pickWhyThisMatters({
    title: match.title || "",
    summary: match.summary || "",
    source: match.source_name || match.source || "",
    category: match.category || "",
    country_tags: match.country_tags || []
  }, WHY_CFG);

  whyText.textContent = why.text;
  whyBox.style.display = "block";

  // RTL support
  const rtl = /[\u0600-\u06FF]/.test(match.summary || "") || /[\u0600-\u06FF]/.test(match.title || "");
  if (rtl) {
    summary.classList.add("rtl");
    title.classList.add("rtl");
  }

  // (optional) wire share/copy buttons here if you want
}
load();
</script>
</body>
</html>
