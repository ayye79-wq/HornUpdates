<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horn Updates â€¢ Reader</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f5f6f8;
      color: #111827;
      line-height: 1.6;
    }
    .wrap { max-width: 920px; margin: 0 auto; padding: 18px; }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px; margin-bottom: 14px;
    }
    .brand a { text-decoration: none; color: #111827; font-weight: 900; }
    .btn {
      display: inline-block;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
    }
    .btn:hover { filter: brightness(0.98); }
/* Secondary buttons look softer */
.btn.secondary{
  background:#f3f4f6;
  border-color:#e5e7eb;
  font-weight:600;
}


    /* âœ… Actions row for buttons */
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      box-shadow: 0 10px 28px rgba(0,0,0,.06);
      padding: 18px;
    }
    .meta { color: #6b7280; font-size: .95rem; display: flex; flex-wrap: wrap; gap: 10px; }
    .pill { background: #f3f4f6; padding: 4px 10px; border-radius: 999px; font-size: .85rem; }
    h1 { font-size: 1.4rem; line-height: 1.25; margin: 10px 0 10px; }
    .summary { margin-top: 10px; font-size: 1.02rem; white-space: pre-wrap; }
    .divider { height: 1px; background: #e5e7eb; margin: 14px 0; }
    .muted { color: #6b7280; }
    .error { color: #b91c1c; font-weight: 700; }

    /* RTL support for Arabic */
    .rtl {
      direction: rtl;
      text-align: right;
      line-height: 1.9;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    }

    @media (max-width: 520px) {
      .btn { padding: 9px 10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <a href="index.html">Horn Updates</a>
        <span class="muted">â€¢ Reader</span>
      </div>

      <div class="actions">
<a id="openBtn" class="btn" target="_blank" rel="noopener noreferrer">Read full article â†—</a>
<button id="copyBtn" class="btn secondary" type="button">Copy link</button>
<button id="shareBtn" class="btn secondary" type="button">Share</button>
<a id="waBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">WhatsApp</a>
<a id="tgBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">Telegram</a>
<a id="fbBtn" class="btn secondary" target="_blank" rel="noopener noreferrer">Facebook</a>

      </div>
    </div>

    <div class="card">
      <div class="meta" id="metaLine">
        <span class="pill" id="sourcePill">Source</span>
        <span class="pill" id="datePill">Date</span>
        <span class="pill" id="catPill" style="display:none;">Category</span>
        <span class="pill" id="countryPill" style="display:none;">Country</span>
      </div>

      <h1 id="title">Loadingâ€¦</h1>

      <div class="divider"></div>

      <div id="summary" class="summary">
        <span class="muted">Loading summaryâ€¦</span>
      </div>

      <div class="divider"></div>

      <div class="muted" style="font-size:.95rem;">
        <strong>Attribution:</strong> This summary is written by Horn Updates. Full article remains on the publisherâ€™s website.
      </div>
    </div>
  </div>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function safeHost(u) {
      try { return new URL(u).hostname.replace(/^www\./, ""); }
      catch { return ""; }
    }

    function formatDate(d) {
      if (!d) return "";
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return d;
      return dt.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function decodeEntities(str) {
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }

    function isArabic(text) {
      return /[\u0600-\u06FF]/.test(text || "");
    }

    function htmlToCleanText(raw) {
      const decoded = decodeEntities(raw || "");
      if (/<[a-z][\s\S]*>/i.test(decoded)) {
        const temp = document.createElement("div");
        temp.innerHTML = decoded;
        temp.querySelectorAll("img, script, style, iframe").forEach(el => el.remove());
        return (temp.innerText || "").trim();
      }
      return decoded.trim();
    }

    function renderSafeTextAsHtml(text) {
      const safe = escapeHtml(text || "");
      return safe.replace(/\n/g, "<br>");
    }

    function normalize(u) {
      try {
        const x = new URL(u);
        return x.hostname.replace(/^www\./, "") + x.pathname.replace(/\/$/, "");
      } catch {
        return "";
      }
    }
function ensureLeadText(text, title) {
  const clean = (text || "").trim();
  if (!clean) return "";

  // Split into sentences (English + Arabic)
  let sentences = clean
    .split(/(?<=[.!?ØŸÛ”])\s+/)
    .map(s => s.trim())
    .filter(s => s.length > 20); // ignore very short fragments

  // Take up to 3 sentences max
  let lead = sentences.slice(0, 3).join(" ");

  // If still too short (truncated RSS), add a neutral line
  const rtl = isArabic(lead) || isArabic(title);
  if (lead.length < 120) {
    lead += rtl
      ? "\n\nØ§Ù‚Ø±Ø£ Ø§Ù„Ø®Ø¨Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ø¨Ø± Horn Updates."
      : "\n\nRead the full story via Horn Updates.";
  }

  return lead;
}

    async function load() {
      const articleUrl = getParam("url");
const shareUrl = window.location.origin + window.location.pathname + window.location.search;

 // Horn Updates reader link (for tracking)

if (!articleUrl) {
  ["openBtn", "copyBtn", "shareBtn", "waBtn", "tgBtn", "fbBtn"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });

  document.getElementById("title").textContent = "Horn Updates Reader";
  document.getElementById("summary").innerHTML = `
    <p class="muted">
      This page shows clean summaries of news stories from the Horn of Africa.
    </p>
    <p>
      Please open an article from <strong>hornupdates.com</strong>.
    </p>
    <p>
      ðŸ‘‰ <a href="https://hornupdates.com">Go to homepage</a>
    </p>
    <p class="muted" style="font-size:.9rem;">
      Redirecting you shortlyâ€¦
    </p>
  `;

  setTimeout(() => {
    window.location.href = "https://hornupdates.com";
  }, 5000);

  return;
}


      // Set open button
      const openBtn = document.getElementById("openBtn");
      openBtn.href = articleUrl;

      // ---- SHARE BUTTONS LOGIC (defaults) ----
      const shareBtn = document.getElementById("shareBtn");
      const waBtn = document.getElementById("waBtn");
      const tgBtn = document.getElementById("tgBtn");
      const fbBtn = document.getElementById("fbBtn");

      // Default fallback (URL only)
waBtn.href = `https://wa.me/?text=${encodeURIComponent(shareUrl)}`;
tgBtn.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}`;
fbBtn.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;


      // Share button: native share on mobile, else copy link on desktop
      shareBtn.onclick = async () => {
        const titleText = document.getElementById("title")?.textContent || "Horn Updates";
        const isRtl = document.getElementById("summary")?.classList.contains("rtl");

        const shareText = isRtl
         ? `${titleText}\n\nØ§Ù‚Ø±Ø£ Ø§Ù„Ø®Ø¨Ø± Ø¹Ø¨Ø± Horn Updates:\n${shareUrl}`
: `${titleText}\n\nRead via Horn Updates:\n${shareUrl}`;


        if (navigator.share) {
          try {
            await navigator.share({ title: "Horn Updates", text: shareText, url: shareUrl });
          } catch (_) {}
        } else {
          try {
            await navigator.clipboard.writeText(shareUrl);
            alert(isRtl ? "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!" : "Link copied!");
          } catch {
            prompt(isRtl ? "Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:" : "Copy this link:", shareUrl);
          }
        }
      };

   
   // Copy button (copies Horn Updates reader link)
document.getElementById("copyBtn").onclick = async () => {
  const isRtl = document.getElementById("summary")?.classList.contains("rtl");
  try {
    await navigator.clipboard.writeText(shareUrl);
    alert(isRtl ? "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!" : "Link copied!");
  } catch {
    prompt(isRtl ? "Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:" : "Copy this link:", shareUrl);
  }
};


      // Defaults (in case not found in JSON)
      const host = safeHost(articleUrl);
      document.getElementById("sourcePill").textContent = host ? `Source: ${host}` : "Source";
      document.getElementById("datePill").textContent = "Date: â€”";
      document.getElementById("title").textContent = "Article";
      document.getElementById("summary").innerHTML =
        `<p class="muted">Weâ€™re loading the summary for this storyâ€¦</p>`;

      // Try to match article in articles.json
      try {
        const res = await fetch("articles.json", { cache: "no-store" });
        const data = await res.json();
        const articles = Array.isArray(data) ? data : (data.articles || []);

        const target = normalize(articleUrl);

        const match = articles.find(a => {
          const candidate = normalize(a.url || a.link || a.source_url || "");
          return candidate === target;
        });

        if (!match) {
          document.getElementById("summary").innerHTML =
            `<p class="muted">We could not match this article inside <code>articles.json</code>. You can still read the full story using the button above.</p>`;
          return;
        }

        const title = match.title || "Article";
        const rawSummary = match.summary || match.excerpt || match.ai_summary || "";
        const published = match.published_at || match.published || match.date || "";
        const sourceName = match.source || match.source_name || host || "Source";
        const category = match.category || "";
        const countries = Array.isArray(match.countries) ? match.countries.join(", ") : (match.countries || "");

        document.getElementById("title").textContent = title;
        document.getElementById("sourcePill").textContent = `Source: ${sourceName}`;
        document.getElementById("datePill").textContent = `Date: ${published ? formatDate(published) : "â€”"}`;

        if (category) {
          const el = document.getElementById("catPill");
          el.style.display = "inline-block";
          el.textContent = `Category: ${category}`;
        }

        if (countries) {
          const el = document.getElementById("countryPill");
          el.style.display = "inline-block";
          el.textContent = `Country: ${countries}`;
        }

       let cleanText = htmlToCleanText(rawSummary);
cleanText = ensureLeadText(cleanText, title);

        const summaryEl = document.getElementById("summary");

        if (cleanText) {
          summaryEl.innerHTML = `<p>${renderSafeTextAsHtml(cleanText)}</p>`;

          const rtl = isArabic(cleanText) || isArabic(title);
          if (rtl) {
            summaryEl.classList.add("rtl");
            document.getElementById("title").classList.add("rtl");
            summaryEl.setAttribute("dir", "rtl");
            document.getElementById("title").setAttribute("dir", "rtl");
          }

          // Upgrade share links with proper text after we know the title/lang
          const shareMsg = rtl
          ? `${title}\n\nØ§Ù‚Ø±Ø£ Ø§Ù„Ø®Ø¨Ø± Ø¹Ø¨Ø± Horn Updates:\n${shareUrl}`
: `${title}\n\nRead via Horn Updates:\n${shareUrl}`;


         waBtn.href = `https://wa.me/?text=${encodeURIComponent(shareMsg)}`;
tgBtn.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent("Horn Updates â€” " + title)}`;

fbBtn.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;

        } else {
          summaryEl.innerHTML = `<p class="muted">Summary not available for this story yet.</p>`;
        }

      } catch (e) {
        console.warn("Reader load error:", e);
        document.getElementById("summary").innerHTML =
          `<p class="muted">Could not load <code>articles.json</code>. Please try again.</p>`;
      }
    }

    load();
  </script>
</body>
</html>
