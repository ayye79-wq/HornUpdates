<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Horn Updates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/favicon.ico" />
</head>

<body>
<div class="page">

  <!-- HEADER -->
  <header class="site-header">
    <div class="brand">
      <img src="Horn1_logo.png" class="logo" />
      <div>
        <h1>Horn Updates</h1>
        <p class="tagline">News from the Horn of Africa</p>
      </div>
    </div>

    <nav class="nav-filters">
      <button class="filter-pill active" data-filter="all">All</button>
      <button class="filter-pill" data-filter="politics">Politics</button>
      <button class="filter-pill" data-filter="business">Business</button>
      <button class="filter-pill" data-filter="society">Society</button>
      <button class="filter-pill" data-filter="security">Security</button>
      <button class="filter-pill" data-filter="culture">Culture</button>
      <button class="filter-pill" data-filter="diaspora">Diaspora</button>
    </nav>
  </header>

  <p class="intro">
    HornUpdates aggregates trusted sources like Reuters, BBC, and VOA,
    delivering AI-powered summaries focused on the Horn of Africa.
  </p>

  <!-- BREAKING -->
  <section class="breaking-bar">
    <span class="breaking-label">BREAKING</span>
    <a id="breaking-link" class="breaking-link"></a>
  </section>

  <!-- CONTENT -->
  <main class="content">

    <section class="featured-section">
      <h2>Featured story</h2>
      <div id="featured-container"></div>
    </section>

    <section class="latest-section">
      <h2>Latest stories</h2>
      <div id="latest-container"></div>
    </section>

  </main>

  <footer class="site-footer">
    © 2025 Horn Updates
  </footer>
</div>

<script>
/* ===================== HELPERS ===================== */

const buildReaderLink = url =>
  "reader.html?url=" + encodeURIComponent(url || "#");

const clamp = (t, n) => t && t.length > n ? t.slice(0,n) + "…" : (t || "");

const getCountries = a =>
  Array.isArray(a.countries) ? a.countries :
  Array.isArray(a.country_tags) ? a.country_tags : [];

function pickRotatingFeatured(list) {
  const pool = list.slice(1, 8);
  const last = sessionStorage.getItem("horn_last_featured") || "";
  let pick = pool[0];

  for (let i = 0; i < pool.length; i++) {
    const c = pool[Math.floor(Math.random() * pool.length)];
    const key = (c.source_url || c.link || "").trim();
    if (key && key !== last) {
      pick = c;
      sessionStorage.setItem("horn_last_featured", key);
      break;
    }
  }
  return pick;
}

/* ===================== RENDER ===================== */

function renderCard(a, featured=false) {
  const countries = getCountries(a).map(c=>`<span class="tag-pill">${c}</span>`).join("");
  return `
  <article class="story-card ${featured ? "story-card--featured":""}">
    <header>
      <div class="story-tags">${countries}<span class="tag-pill tag-category">${a.category||"General"}</span></div>
      <h3><a href="${buildReaderLink(a.source_url||a.link)}">${clamp(a.title, featured?160:120)}</a></h3>
    </header>
    ${a.summary ? `<p>${clamp(a.summary, featured?280:220)}</p>` : ""}
    <footer>${a.source_name||""} ${a.published_at||""}</footer>
  </article>`;
}

function setBreaking(a) {
  const el = document.getElementById("breaking-link");
  el.textContent = clamp(a.title,140);
  el.href = buildReaderLink(a.source_url||a.link);
}

/* ===================== STATE ===================== */

let allArticles = [];
let filter = "all";

/* ===================== FILTER ===================== */

function applyFilter() {
  const list = filter==="all"
    ? allArticles
    : allArticles.filter(a =>
        JSON.stringify(a).toLowerCase().includes(filter)
      );

  render(list.length ? list : allArticles);
}

function render(list) {
  const featuredEl = document.getElementById("featured-container");
  const latestEl = document.getElementById("latest-container");

  const breaking = list[0];
  const featured = pickRotatingFeatured(list) || breaking;
  const latest = list.filter(a => a!==breaking && a!==featured);

  setBreaking(breaking);
  featuredEl.innerHTML = renderCard(featured,true);
  latestEl.innerHTML = latest.map(a=>renderCard(a)).join("");
}

document.querySelectorAll(".filter-pill").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".filter-pill").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    filter=b.dataset.filter;
    applyFilter();
  }
});

/* ===================== LOAD ===================== */

fetch("articles.json?ts="+Date.now(),{cache:"no-store"})
  .then(r=>r.json())
  .then(d=>{
    const list = Array.isArray(d.articles)?d.articles:d;
    const seen=new Set();
    allArticles=list.filter(a=>{
      const u=(a.source_url||a.link||"").trim();
      if(!u||seen.has(u))return false;
      seen.add(u);return true;
    }).sort((a,b)=>Date.parse(b.published_at||0)-Date.parse(a.published_at||0));
    applyFilter();
  })
  .catch(e=>console.error("Load failed",e));

</script>
</body>
</html>
