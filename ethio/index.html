<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EthioPulse</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#111827">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EthioPulse">
<link rel="apple-touch-icon" href="/ethio/icons/icon-192.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7773342225754932"
     crossorigin="anonymous"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <!-- Sidebar layout + X feed styles (kept inline so you don't have to edit style.css) -->
  <style>
    /* Two-column layout (main + right sidebar) */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 20px;
      align-items: start;
      margin-top: 12px;
    }
    .sidebar {
      position: sticky;
      top: 16px;
    }
    .sidebar-box {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .sidebar-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 10px 0;
    }

    /* Hide sidebar on mobile for better UX */
   @media (max-width: 900px) {
  .layout { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  .sidebar { display: none; }
}

  </style>
</head>

<body>
  <div class="page">
    <!-- HEADER -->
    <header class="site-header">
      <div class="brand">
        <div class="brand-text">
  <h1>EthioPulse</h1>
  <p class="tagline">Ethiopia, in real time.</p>
</div>

      </div>

      <!-- FILTER NAV -->
      <nav class="nav-filters">
        <button class="filter-pill active" data-filter="all">All</button>
        <button class="filter-pill" data-filter="Politics">Politics</button>
        <button class="filter-pill" data-filter="Business">Business</button>
        <button class="filter-pill" data-filter="Society">Society</button>
        <button class="filter-pill" data-filter="Security">Security</button>
        <button class="filter-pill" data-filter="Culture">Culture</button>
        <button class="filter-pill" data-filter="Diaspora">Diaspora</button>
      </nav>
    </header>

    <!-- INTRO -->
    <p class="intro">
      EthioPulse tracks Ethiopia-focused Telegram and RSS sources and shows short, fast headlines with links to the originals.

    </p>

    <!-- BREAKING BAR -->
    <section class="breaking-bar" id="breaking-bar">
      <span class="breaking-label">BREAKING</span>
      <a id="breaking-link" class="breaking-link" href="#"></a>
    </section>

    <!-- MAIN LAYOUT: CONTENT + RIGHT SIDEBAR -->
    <div class="layout">
      <!-- FEATURED STORY + LATEST STORIES -->
      <main class="content">
        <section class="featured-section">
          <h2>Featured story</h2>
          <div id="featured-container"></div>
        </section>

        <!-- LATEST STORIES -->
        <section class="latest-section">
          <h2>Latest stories</h2>
          <div id="latest-container"></div>
        </section>
      </main>

      <!-- RIGHT SIDEBAR (X FEED) -->
<aside class="sidebar">
  <div class="sidebar-box about-mini">
    <h3>About EthioPulse</h3>
    <p>
      Live Ethiopia-only pulse feed. Short summaries. Click through for the full source.
    </p>
    <p id="last-updated" style="margin-top:10px;font-size:.9rem;opacity:.8"></p>
  </div>
</aside>



    </div>

    <!-- FOOTER -->
    <footer class="site-footer">
      <p>© 2026 EthioPulse. All rights reserved.
       </p>
      <p class="footer-meta">
  Sources include Ethiopia-focused Telegram channels and RSS feeds.
</p>

    </footer>
  </div>




  <!-- MAIN JS LOGIC -->
  <script>
  // ---------- HELPERS ----------
  function buildReaderLink(sourceUrl) {
    return "../reader.html?url=" + encodeURIComponent(sourceUrl || "#");
  }
  function getCountries(article) {
  const raw =
    article.countries ||
    article.country_tags ||
    (article.country ? [article.country] : []);
  if (!raw) return [];
  if (Array.isArray(raw)) return raw;
  return [String(raw)];
}
  function formatCountries(article) {
    const countries = getCountries(article);
    return countries.join(" • ");
  }

  function clamp(text, max) {
    if (!text) return "";
    return text.length > max ? text.slice(0, max) + "…" : text;
  }

  // Prefer topic_tags from Python (array), fall back to older fields
  function getTopicLabel(article) {
    if (Array.isArray(article.topic_tags) && article.topic_tags.length) {
      return String(article.topic_tags[0] || "").trim() || "General";
    }
    return (
      String(article.category || "").trim() ||
      String(article.topic || "").trim() ||
      "General"
    );
  }

  function niceDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return isNaN(d) ? String(iso) : d.toLocaleString();
  }

  // ---------- RENDER FUNCTIONS ----------
  function renderStoryCard(article, isFeatured = false) {
    const countriesArr = getCountries(article);
    const category = getTopicLabel(article);
    const published = article.published_at || "";
    const sourceName = article.source_name || article.source || "";
    const href = buildReaderLink(article.source_url || article.link);

    const title = clamp(article.title || "Untitled story", isFeatured ? 160 : 120);
    const summary = clamp(
      article.summary || article.excerpt || "",
      isFeatured ? 280 : 220
    );

    const cardClass = "story-card" + (isFeatured ? " story-card--featured" : "");

    const countryTags = countriesArr
      .map(c => `<span class="tag-pill">${c}</span>`)
      .join("");

    return `
      <article class="${cardClass}">
        <header class="story-header">
          <div class="story-tags">
            ${countryTags}
            <span class="tag-pill tag-category">${category}</span>
          </div>
          <h3 class="story-title">
            <a class="story-link" href="${href}">
              ${title}
            </a>
          </h3>
        </header>
        ${summary ? `<p class="story-summary">${summary}</p>` : ""}
        <footer class="story-meta">
          ${sourceName ? `<span class="story-source">${sourceName}</span>` : ""}
          ${published ? `<span class="story-date">${niceDate(published)}</span>` : ""}
        </footer>
      </article>
    `;
  }

  function setBreakingBar(article) {
    const linkEl = document.getElementById("breaking-link");
    if (!linkEl || !article) return;

    const countriesStr = formatCountries(article);
    let label = article.title || "";
    if (countriesStr) label += " — " + countriesStr;
    label = clamp(label, 140);

    linkEl.textContent = label;
    linkEl.href = buildReaderLink(article.source_url || article.link);
  }

  // ---------- STATE ----------
  let allArticles = [];
  let currentFilter = "all";

  function matchesFilter(article, filter) {
    if (filter === "all") return true;
    const needle = String(filter || "").toLowerCase();

    const countries = getCountries(article).join(" ").toLowerCase();

    // Combine topic_tags + older fields into one searchable string
    const topics = (
      (Array.isArray(article.topic_tags) ? article.topic_tags.join(" ") : "") +
      " " + (article.category || "") +
      " " + (article.topic || "")
    ).toLowerCase();

    const title = (article.title || "").toLowerCase();
    const summary = (article.summary || article.excerpt || "").toLowerCase();
    const source = (article.source_name || article.source || "").toLowerCase();

    return (
      countries.includes(needle) ||
      topics.includes(needle) ||
      title.includes(needle) ||
      summary.includes(needle) ||
      source.includes(needle)
    );
  }

  function renderPage(filteredList) {
    const featuredContainer = document.getElementById("featured-container");
    const latestContainer = document.getElementById("latest-container");

    if (!filteredList.length) {
      featuredContainer.innerHTML = "<p>No stories available.</p>";
      latestContainer.innerHTML = "";
      return;
    }

    const featured = filteredList[0];
    const latest = filteredList.slice(1);

    featuredContainer.innerHTML = renderStoryCard(featured, true);
    latestContainer.innerHTML = latest.map(a => renderStoryCard(a, false)).join("");

    setBreakingBar(featured);
  }

  function applyFilter() {
    const filtered = allArticles.filter(a => matchesFilter(a, currentFilter));
    renderPage(filtered.length ? filtered : allArticles);
  }

  function setupFilters() {
    document.querySelectorAll(".filter-pill").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-pill").forEach(b =>
          b.classList.remove("active")
        );
        btn.classList.add("active");
        currentFilter = btn.dataset.filter || "all";
        applyFilter();
      });
    });
  }

  function loadArticles() {
    // Cache-buster ensures you always see the newest articles.json
   fetch("./ethio_articles.json?v=" + Date.now())

      .then(res => res.json())
      .then(data => {
        let list = Array.isArray(data) ? data : (data.articles || []);
		const updatedEl = document.getElementById("last-updated");
       if (updatedEl && data.generated_at) {
     updatedEl.textContent = "Last updated: " + niceDate(data.generated_at);
    }

        list = list.filter(a => a.title && (a.source_url || a.link));

        // Sort newest first
        list.sort((a, b) => {
          const da = new Date(a.published_at || 0);
          const db = new Date(b.published_at || 0);
          return db - da;
        });

        allArticles = list;
        applyFilter();
      })
      .catch(err => {
        console.error("Error loading ethio_articles.json:", err);
        document.getElementById("featured-container").innerHTML =
          "<p>Failed to load stories.</p>";
      });
  }

  window.addEventListener("DOMContentLoaded", () => {
    setupFilters();
    loadArticles();
  });
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    // Important: unregister any old SWs that might be controlling the site
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) await r.unregister();

    // Now register EthioPulse SW under /ethio/
    await navigator.serviceWorker.register("./sw.js");
  });
}
</script>


</body>
</html>
